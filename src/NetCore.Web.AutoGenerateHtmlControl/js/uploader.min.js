(function(n){n.fn.InitUploader=function(t){t=n.extend({data:[],container:this,base_url:"",server_url:"/api/upload",multiple:!1,chunked:!1,chunkSize:null,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png,pdf",mimeTypes:"image/*"},btns:{uploadBtnText:"开始上传",addFileBtnText:"添加文件",pauseBtnText:"暂停上传",continueBtnText:"继续上传"},formData:null,fileNumLimit:10,fileSingleSizeLimit:5242880,threads:1,thumb:{width:100,height:100,quality:70,crop:!0,allowMagnify:!1}},t);var i;return this.each(function(){function tt(t){var i=u('<li id="'+t.id+'"><p class="imgWrap"><\/p><p class="progress"><span><\/span><\/p><\/li>'),f=u('<div class="file-panel"><span class="cancel"><\/span><span class="rotateRight"><\/span><span class="rotateLeft"><\/span><\/div>').appendTo(i),o=i.find("p.progress span"),r=i.find("p.imgWrap"),h=u('<p class="error"><\/p>'),e=function(n){switch(n){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}h.text(text).appendTo(i)};t.getStatus()==="invalid"?e(t.statusText):(r.text("Loading..."),n.makeThumb(t,function(n,t){if(n){r.text("不能预览");return}var i=u('<img src="'+t+'">');r.empty().append(i)},d,g),s[t.id]=[t.size,0],t.rotation=0);t.on("statuschange",function(n,r){r==="progress"?o.hide().width(0):r==="queued"&&(i.off("mouseenter mouseleave"),f.remove());n==="error"||n==="invalid"?(console.log(t.statusText),e(t.statusText),s[t.id][1]=1):n==="interrupt"?e("interrupt"):n==="queued"?s[t.id][1]=0:n==="progress"?(h.remove(),o.css("display","block")):n==="complete"&&i.append('<span class="success"><\/span>');i.removeClass("state-"+r).addClass("state-"+n)});i.on("mouseenter",function(){f.stop().animate({height:30})});i.on("mouseleave",function(){f.stop().animate({height:0})});f.on("click","span",function(){var f=u(this).index(),i;switch(f){case 0:n.removeFile(t);return;case 1:t.rotation+=90;break;case 2:t.rotation-=90}nt?(i="rotate("+t.rotation+"deg)",r.css({"-webkit-transform":i,"-mos-transform":i,"-o-transform":i,transform:i})):r.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(t.rotation/90%4+4)%4+")")});i.appendTo(c)}function it(n){var t=u("#"+n.id);delete s[n.id];a();t.off().find(".file-panel").off().end().remove()}function a(){var i=0,n=0,r=v.children(),t;u.each(s,function(t,r){n+=r[0];i+=r[0]*r[1]});t=n?i/n:0;r.eq(0).text(Math.round(t*100)+"%");r.eq(1).css("width",Math.round(t*100)+"%");k()}function k(){var i="",t;r==="ready"?i="选中"+o+"个文件，共"+WebUploader.formatSize(y)+"。":r==="confirm"?(t=n.getStats(),t.uploadFailNum&&(i='成功 <span class="text-warning">'+t.successNum+'<\/span> 个，失败 <span class="text-success">'+t.uploadFailNum+'<\/span> 个，点击<a class="retry font-weight-bold" href="javascript:;"> 重新上传 <\/a>失败文件')):(t=n.getStats(),i="共"+o+"个（"+WebUploader.formatSize(y)+"），已上传"+t.successNum+"个",t.uploadFailNum&&(i+="，失败"+t.uploadFailNum+"个"));b.html(i)}function h(i){var u;if(i!==r){e.removeClass("state-"+r);e.addClass("state-"+i);r=i;switch(r){case"pedding":w.removeClass("element-invisible");c.parent().removeClass("filled");c.hide();l.addClass("element-invisible");n.refresh();break;case"ready":w.addClass("element-invisible");p.removeClass("element-invisible");c.parent().addClass("filled");c.show();l.removeClass("element-invisible");n.refresh();break;case"uploading":p.addClass("element-invisible");v.show();e.text(t.btns.pauseBtnText);break;case"paused":v.show();e.text(t.btns.continueBtnText);break;case"confirm":if(v.hide(),e.text(t.btns.uploadBtnText).addClass("disabled"),u=n.getStats(),u.successNum&&!u.uploadFailNum){h("finish");return}break;case"finish":u=n.getStats();u.successNum?alert("上传成功"):(r="done",location.reload())}k()}}var u=jQuery,f=t.container,c=f.find(".filelist"),l=f.find(".statusBar"),b=l.find(".info"),e=f.find(".uploadBtn"),w=f.find(".placeholder"),v=l.find(".progress").hide(),o=0,y=0,d=t.thumb.width,g=t.thumb.height,r="pedding",s={},nt=function(){var n=document.createElement("p").style,t="transition"in n||"WebkitTransition"in n||"MozTransition"in n||"msTransition"in n||"OTransition"in n;return n=null,t}(),p=f.find(".footer-add-btn"),n;if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.");}i=n=WebUploader.create({pick:{id:f.find(".filePicker"),label:t.btns.addFileBtnText,multiple:t.multiple},dnd:f.find(".queueList"),paste:document.body,accept:t.accept,formData:t.formData,disableGlobalDnd:!0,thumb:t.thumb,compress:t.compress,chunked:t.chunked,chunkSize:t.chunkSize,server:t.server_url,fileNumLimit:t.fileNumLimit,threads:t.threads,fileSingleSizeLimit:t.fileSingleSizeLimit});n.addButton({id:p,label:t.btns.addFileBtnText}).then(function(){p.find("div:eq(1)").css({width:"100%",height:"100%"})});n.onUploadProgress=function(n,t){var i=u("#"+n.id),r=i.find(".progress span");r.css("width",t*100+"%");s[n.id][1]=t;a()};n.onFileQueued=function(n){o++;y+=n.size;o===1&&(w.addClass("element-invisible"),l.show());tt(n);h("ready");a()};n.onFileDequeued=function(n){o--;y-=n.size;o||h("pedding");it(n);a()};n.on("all",function(n){switch(n){case"uploadFinished":h("confirm");break;case"startUpload":h("uploading");break;case"stopUpload":h("paused")}});n.onError=function(n){alert("Eroor: "+n)};e.on("click",function(){if(u(this).hasClass("disabled"))return!1;r==="ready"?n.upload():r==="paused"?n.upload():r==="uploading"&&n.stop()});b.on("click",".retry",function(){n.retry()});e.addClass("state-"+r);a()}),i}})(jQuery);